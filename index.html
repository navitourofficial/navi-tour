<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NAVI TOUR</title>

  <!-- ‚úÖ GitHub PagesÏö© ÎèôÏ†Å BASE ÏÑ§Ï†ï -->
  <script>
    (function () {
      const seg = location.pathname.split('/').filter(Boolean);
      const base = (location.hostname.endsWith('.github.io') && seg.length > 0)
        ? '/' + seg[0] + '/'
        : '/';
      const b = document.createElement('base');
      b.setAttribute('href', base);
      document.head.prepend(b);
    })();
  </script>

  <!-- Ìè∞Ìä∏ & ÏïÑÏù¥ÏΩò -->
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;700&family=Playfair+Display:wght@400;600&family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- üîó Î©îÏù∏/Ïª¥Ìè¨ÎÑåÌä∏ Ïä§ÌÉÄÏùº -->
  <link rel="stylesheet" href="style/main.css">
  <link rel="stylesheet" href="products/X_prod.css">
  <!-- ‚úÖ Î°úÍ≥†/Ìó§Îçî ÌÜµÌï© CSS (boot Ï£ºÏûÖÎêú Ìó§Îçî ÎßàÌÅ¨ÏóÖÍ≥º Ìï®Íªò ÎèôÏûë) -->
  <link rel="stylesheet" href="layout/X_layout.css?v=20251025">

  <!-- ‚ö° Î∂ÄÌä∏ Ïä§ÌÅ¨Î¶ΩÌä∏ ÌîÑÎ¶¨Î°úÎìú (KPGÏôÄ ÎèôÏùº Ìå®ÌÑ¥) -->
  <link rel="modulepreload" href="lib/boot.js">
</head>
<body class="home">

  <main id="page" data-region="home">
    <!-- Hero (Ï†ÑÏó≠ CSSÏóê ÏùòÌï¥ Ïä§ÌÉÄÏùºÎê®. ÌïÑÏöî Ïãú Î∂ÄÌä∏Í∞Ä global_layoutÎ•º ÏÑ∏ÌåÖ) -->
    <section class="hero">
      <div>
        <h1></h1>
        <p></p>
      </div>
    </section>

    <!-- ÏΩòÏãúÏñ¥ÏßÄ (boot.jsÍ∞Ä #layout-conciergeÎ•º Ï£ºÏûÖÌï¥ Ïù¥ Ïä¨Î°ØÏùÑ ÍµêÏ≤¥) -->
    <div id="concierge-slot"></div>

    <!-- ‚ñº ÌïÑÌÑ∞: main_filter.htmlÏùÑ 'ÏßÄÍ∏àÏ≤òÎüº' Î°úÎìúÌïòÏó¨ Ïó¨Í∏∞ ÍµêÏ≤¥ -->
    <div id="filter-slot"></div>

    <!-- ÏÉÅÌíàÎ¶¨Ïä§Ìä∏ -->
    <section class="grid3" id="list"></section>

    <!-- ÌïòÎã® CTA (boot.jsÍ∞Ä #layout-bottom-ctaÎ°ú ÍµêÏ≤¥) -->
    <div id="bottom-cta-slot"></div>
  </main>

  <!-- =========================
       1) ÌïÑÌÑ∞Îßå Îã®ÎèÖ Ï£ºÏûÖ (Í∏∞Ï°¥ Î∞©Ïãù Ïú†ÏßÄ)
       ========================= -->
  <script>
    async function injectFilterOnly(){
      const filterSlot = document.getElementById('filter-slot');
      if(!filterSlot) return;

      const adoptStyles = (doc)=>{
        doc.querySelectorAll('style, link[rel="stylesheet"]').forEach(node=>{
          document.head.appendChild(node.cloneNode(true));
        });
      };
      const runScripts = (root)=>{
        root.querySelectorAll('script').forEach(sc=>{
          const s = document.createElement('script');
          if (sc.type) s.type = sc.type;
          if (sc.src) { s.src = sc.src; s.async = false; }
          else { s.textContent = sc.textContent; }
          document.body.appendChild(s);
        });
      };

      try{
        const res  = await fetch('layout/main_filter.html', { cache: 'no-store' });
        const html = await res.text();
        const doc  = new DOMParser().parseFromString(html,'text/html');

        const $filterTpl = doc.getElementById('layout-main-filter');
        if ($filterTpl) {
          filterSlot.replaceWith($filterTpl.content.cloneNode(true));
          adoptStyles(doc);
          runScripts($filterTpl.content);
        } else {
          const frag = document.createRange().createContextualFragment(html);
          const nf = frag.querySelector('#navifilter');
          if (nf) {
            filterSlot.replaceWith(nf);
            adoptStyles(doc);
            runScripts(frag);
          } else {
            const wrap = document.createElement('div');
            wrap.innerHTML = html;
            filterSlot.replaceWith(wrap);
            adoptStyles(doc);
            runScripts(wrap);
          }
        }
      }catch(e){
        console.error('filter include failed:', e);
      }
    }
  </script>

  <!-- =========================
       2) ÏÉÅÌíà Î°úÎçî + ÌïÑÌÑ∞ Ïó∞Îèô (Í∏∞Ï°¥ Î°úÏßÅ Ïú†ÏßÄ)
       ========================= -->
  <script>
    const list = document.getElementById('list');
    let cards = [];
    let originalOrder = new WeakMap();
    let __productsLoaded = false;

    async function loadProducts(){
      if (__productsLoaded) return;
      try{
        const res  = await fetch('products/main_prod.html', { cache: 'no-store' });
        if (!res.ok) throw new Error('main.products.html Î°úÎìú Ïã§Ìå® ('+res.status+')');
        const html = await res.text();
        const doc  = new DOMParser().parseFromString(html, 'text/html');
        const tpl  = doc.getElementById('main-products');
        if(!tpl){ console.warn('main-products template not found.'); return; }
        list.innerHTML = '';
        list.appendChild(tpl.content.cloneNode(true));
        cards = Array.from(list.querySelectorAll('.card'));
        cards.forEach((c,i)=>originalOrder.set(c,i));
        __productsLoaded = true;
      }catch(e){
        console.error('Failed to load products:', e);
        list.innerHTML = `<div style="padding:40px;text-align:center;color:#888;">ÏÉÅÌíà Ï†ïÎ≥¥Î•º Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.<br>${e.message}</div>`;
      }
    }

    function waitForFilter(){
      return new Promise(resolve=>{
        const t = setInterval(()=>{
          if (window.NaviFilter && window.NaviFilter.root){ clearInterval(t); resolve(window.NaviFilter); }
        },50);
      });
    }

    function bucketDays(n){
      n = Number(n||0);
      if(n<=4) return '3-4';
      if(n<=5) return '4-5';
      if(n<=6) return '5-6';
      if(n<=7) return '6-7';
      return '7+';
    }

    function parseListAttr(el, name){
      const raw = el.dataset[name];
      if(!raw) return [];
      return raw.split(',').map(s=>s.trim()).filter(Boolean);
    }

    const REGION_COUNTRY = {
      // Ï§ëÍµ≠
      seogando:'china', bukgando:'china', shanghai:'china', chongqing:'china', nanjing:'china', changsha:'china', yuzhou:'china',
      // ÏùºÎ≥∏
      tokyo:'japan', kyoto:'japan', osaka:'japan', fukuona:'japan', nagasaki:'japan',
      // Îü¨ÏãúÏïÑ
      vladivostok:'russia', ussurisk:'russia',
      // ÎØ∏Íµ≠
      hawaii:'usa'
    };

    function inferCountryFromCard(card){
      const r = card.dataset.region || '';
      const c = parseListAttr(card,'cities')[0] || '';
      return REGION_COUNTRY[r] || REGION_COUNTRY[c] || card.dataset.country || '';
    }

    function applyFilterFromState(state){
      if(!cards.length) return;

      const kw = (state.keyword||'').toLowerCase();

      cards.forEach(card=>{
        const country = inferCountryFromCard(card);
        const regions = parseListAttr(card,'region') || (card.dataset.region?[card.dataset.region]:[]);
        const cities  = parseListAttr(card,'cities');
        const themes  = parseListAttr(card,'themes');
        const flags   = parseListAttr(card,'flags');

        const price   = Number(card.dataset.price||0);
        const daysNum = Number(card.dataset.days||0);
        const hotel   = String(card.dataset.hotel||'');
        const text    = card.innerText.toLowerCase();

        const okCountry = state.countries.length ? state.countries.includes(country) : true;
        const okRegion  = state.regions.length  ? regions.some(v=>state.regions.includes(v)) : true;
        const okCity    = state.cities.length   ? cities.some(v=>state.cities.includes(v))   : true;

        const bkt = daysNum ? bucketDays(daysNum) : (card.dataset.duration||'');
        const okDur    = state.durations.length ? state.durations.includes(bkt) : true;

        const okPrice  = (price===0) ? true : (price>=state.priceMin && price<=state.priceMax);
        const okHotel  = state.hotels.length ? state.hotels.includes(hotel) : true;
        const okTheme  = state.themes.length ? themes.some(t=>state.themes.includes(t)) : true;
        const okFlags  = state.flags.length  ? state.flags.every(f=>flags.includes(f)) : true;
        const okKw     = kw ? text.includes(kw) : true;

        const visible = okCountry && okRegion && okCity && okDur && okPrice && okHotel && okTheme && okFlags && okKw;
        card.style.display = visible ? '' : 'none';
      });

      // Ï†ïÎ†¨
      const visibleCards = cards.filter(c=>c.style.display!=='none');
      let sorted = visibleCards.slice();

      const byNum = (get)=> (a,b)=>(get(a)-get(b));
      const byNumDesc = (get)=> (a,b)=>(get(b)-get(a));

      if(state.sort==='price_asc') sorted.sort(byNum(c=>Number(c.dataset.price||0)));
      else if(state.sort==='price_desc') sorted.sort(byNumDesc(c=>Number(c.dataset.price||0)));
      else if(state.sort==='days_asc') sorted.sort(byNum(c=>Number(c.dataset.days||0)));
      else if(state.sort==='days_desc') sorted.sort(byNumDesc(c=>Number(c.dataset.days||0)));
      else if(state.sort==='newest') sorted.sort(byNumDesc(c=>Number(c.dataset.updated||0)));
      else /* recommended */ sorted.sort((a,b)=>originalOrder.get(a)-originalOrder.get(b));

      // Ïû¨Î∞∞Ïπò
      sorted.forEach(c=>list.appendChild(c));
    }

    async function setupFilterIntegration(){
      await loadProducts();
      const NF = await waitForFilter();

      try { applyFilterFromState(NF.getState()); } catch(e){ console.warn(e); }

      NF.root.addEventListener('navifilter:change', e=>{
        applyFilterFromState(e.detail);
      });
    }
  </script>

  <!-- ÏàúÏÑú: ‚ë†ÌïÑÌÑ∞ Ï£ºÏûÖ ‚Üí ‚ë°ÌïÑÌÑ∞-ÏÉÅÌíà Ïó∞Îèô -->
  <script>
    (async function bootIndex(){
      await injectFilterOnly();
      await setupFilterIntegration();
    })();
  </script>

  <!-- Í∏∞ÌÉÄ Ïä§ÌÅ¨Î¶ΩÌä∏ -->
  <script src="style/change.js"></script>

  <!-- ‚úÖ KPGÏôÄ ÎèôÏùº: Î∂ÄÌä∏ Î™®Îìà (Ï†ÑÏó≠ Ïä§ÌÉÄÏùº/Ìó§Îçî/Ìë∏ÌÑ∞/ÏΩòÏãúÏñ¥ÏßÄ Ï£ºÏûÖ Îã¥Îãπ) -->
  <script type="module" src="lib/boot.js" defer></script>
</body>
</html>
